FROM remote-signer

# extra build dependencies
RUN BUILD_DEPS=" \
    git \
    gcc-c++ \
    make \
    automake \
    autoconf \
    libtool \
    pkg-config \
    openssl-devel \
    gnutls-utils \
    python3.11-devel.x86_64 \
    "; \
    yum -y install ${BUILD_DEPS}

# SoftHSMv2
# https://github.com/opendnssec/SoftHSMv2
RUN set -x; \
    cd /usr/src; \
    git clone https://github.com/opendnssec/SoftHSMv2; \
    (cd SoftHSMv2; sh autogen.sh; ./configure; make; make install)

# extra python dependencies
RUN set -x; \
    PYTHON_DEV_DEPS=" \
    python-pkcs11 \
    poetry  \
    pre-commit  \
    ipython  \
    pudb  \
    rich-cli  \
    black==22.3.0  \
    ruff  \
    isort  \
    flake8  \
    mypy  \
    pytest-cov"; \
    source /home/ec2-user/env/bin/activate; \
    pip install ${PYTHON_DEV_DEPS}

# set up SoftHSMv2 token and create /keys.json
COPY scripts/create_keys_dot_json.sh  /
RUN set -x;   \
    source /home/ec2-user/env/bin/activate; \
    /create_keys_dot_json.sh; \
    rm /create_keys_dot_json.sh

# this is where we will mount the source code
# to avoid overriting venv in `/src/env`
WORKDIR /code
